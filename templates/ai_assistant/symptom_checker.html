{% extends 'base.html' %}
{% load static %}

{% block title %}AI Symptom Checker{% endblock %}

{% block extra_head %}
<style>
    .chat-container {
        max-width: 800px;
        margin: 20px auto;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
        height: 70vh; /* Adjust as needed */
    }
    .chat-messages {
        flex-grow: 1;
        overflow-y: auto;
        padding: 15px;
        background-color: #f9f9f9;
        border-bottom: 1px solid #eee;
    }
    .message {
        margin-bottom: 10px;
        padding: 8px 12px;
        border-radius: 15px;
        max-width: 75%;
        word-wrap: break-word;
    }
    .message.user-message {
        background-color: #dcf8c6; /* Light green for user */
        align-self: flex-end;
        margin-left: auto;
        text-align: right;
    }
    .message.ai-message {
        background-color: #e0e0e0; /* Light gray for AI */
        align-self: flex-start;
        margin-right: auto;
        text-align: left;
    }
    .message-sender {
        font-weight: bold;
        font-size: 0.8em;
        color: #555;
        margin-bottom: 3px;
    }
    .message-timestamp {
        font-size: 0.7em;
        color: #888;
        margin-top: 5px;
    }
    .chat-input {
        display: flex;
        padding: 15px;
        border-top: 1px solid #eee;
        background-color: #fff;
    }
    .chat-input textarea {
        flex-grow: 1;
        border: 1px solid #ddd;
        border-radius: 20px;
        padding: 10px 15px;
        margin-right: 10px;
        resize: none;
        font-size: 1em;
        line-height: 1.4;
        min-height: 40px;
        max-height: 120px; /* Limit height */
        overflow-y: auto;
    }
    .chat-input button {
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 20px;
        padding: 10px 20px;
        cursor: pointer;
        font-size: 1em;
        transition: background-color 0.3s ease;
    }
    .chat-input button:hover {
        background-color: #0056b3;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="card shadow-lg p-4">
        <h2 class="text-center mb-4">AI-Powered Symptom Checker & Doctor Recommendation</h2>
        
        <div class="chat-container">
            <div class="chat-messages" id="ai-chat-log">
                {# Loop through conversation_history to display all messages #}
                {% for message in conversation_history %}
                    <div class="message {% if message.sender == request.user %}user-message{% else %}ai-message{% endif %}">
                        <div class="message-sender">
                            {% if message.sender == request.user %}You{% else %}AI Assistant{% endif %}
                        </div>
                        <div class="message-content" style="white-space: pre-wrap;">{{ message.content|safe }}</div> {# IMPORTANT: Use '|safe' here #}
                        <div class="message-timestamp">
                            {{ message.timestamp|date:"d/m/Y H:i A" }} {# Indian format #}
                        </div>
                    </div>
                {% endfor %}
            </div>
            <div class="chat-input">
                <textarea id="symptom-input" placeholder="Type your symptoms or query..." rows="1"></textarea>
                <button id="send-button">Send</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Scroll to the bottom of the chat log on page load
    const chatLog = document.getElementById('ai-chat-log');
    chatLog.scrollTop = chatLog.scrollHeight;

    const symptomInput = document.getElementById('symptom-input');
    const sendButton = document.getElementById('send-button');

    sendButton.onclick = function() {
        sendMessage();
    };

    symptomInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) { // Send on Enter, new line on Shift+Enter
            e.preventDefault();
            sendMessage();
        }
    });

    function sendMessage() {
        const symptoms = symptomInput.value;
        if (symptoms.trim() === '') {
            return;
        }
        symptomInput.value = ''; // Clear input field

        // Create a temporary message element for the user's message (optional, as the server will re-render)
        const userMessageDiv = document.createElement('div');
        userMessageDiv.classList.add('message', 'user-message');
        userMessageDiv.innerHTML = `
            <div class="message-sender">You</div>
            <div class="message-content" style="white-space: pre-wrap;">${symptoms}</div>
            <div class="message-timestamp">${new Date().toLocaleString('en-IN', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true })}</div>
        `;
        chatLog.appendChild(userMessageDiv);
        chatLog.scrollTop = chatLog.scrollHeight; // Scroll to bottom

        // Show a loading indicator (optional but good UX)
        const loadingDiv = document.createElement('div');
        loadingDiv.classList.add('message', 'ai-message');
        loadingDiv.id = 'ai-loading-indicator';
        loadingDiv.innerHTML = `<div class="message-sender">AI Assistant</div><div class="message-content">Typing...</div>`;
        chatLog.appendChild(loadingDiv);
        chatLog.scrollTop = chatLog.scrollHeight;


        // Send the message to the server
        fetch(window.location.href, { // Send to the current URL (symptom-checker view)
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken') // Get CSRF token
            },
            body: `symptoms=${encodeURIComponent(symptoms)}`
        })
        .then(response => response.text()) // Get HTML response
        .then(html => {
            // Remove loading indicator
            const oldLoadingDiv = document.getElementById('ai-loading-indicator');
            if (oldLoadingDiv) {
                oldLoadingDiv.remove();
            }

            // Parse the HTML response to get the updated chat log
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const newChatLogContent = doc.getElementById('ai-chat-log').innerHTML;
            
            // Update the chat log with the new content (including AI's response and full history)
            chatLog.innerHTML = newChatLogContent;
            chatLog.scrollTop = chatLog.scrollHeight; // Scroll to bottom again
        })
        .catch(error => {
            console.error('Error sending message:', error);
            // Remove loading indicator
            const oldLoadingDiv = document.getElementById('ai-loading-indicator');
            if (oldLoadingDiv) {
                oldLoadingDiv.remove();
            }

            const errorMessageDiv = document.createElement('div');
            errorMessageDiv.classList.add('message', 'ai-message'); // Show as AI message for error
            errorMessageDiv.innerHTML = `
                <div class="message-sender">AI Assistant</div>
                <div class="message-content">An error occurred while getting AI response. Please try again.</div>
                <div class="message-timestamp">${new Date().toLocaleString('en-IN', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true })}</div>
            `;
            chatLog.appendChild(errorMessageDiv);
            chatLog.scrollTop = chatLog.scrollHeight;
        });
    }

    // Function to get CSRF token (needed for POST requests)
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Adjust textarea height dynamically
    symptomInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });
</script>
{% endblock %}